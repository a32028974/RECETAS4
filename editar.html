<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editar trabajo â€¢ Ã“ptica Cristal</title>
  <link rel="icon" type="image/png" href="logo.png" />
  <!-- Tus estilos globales (los que me pasaste) -->
  <link rel="stylesheet" href="css/estilos.css?v=2025-11-06" />
  <style>
    /* Ajustes mÃ­nimos especÃ­ficos del editor */
    .hdr-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .pill.lock{ background:#fee2e2; color:#991b1b; }
    .pill.unlock{ background:#dcfce7; color:#14532d; }
    .sm { font-size:12px; color:var(--muted); }
    .money input { text-align:right; }
    .right { justify-self: end; }
  </style>
</head>
<body>
  <main class="wrap">

    <!-- ====== ENCABEZADO ====== -->
    <section class="card">
      <div class="title-row">
        <div class="brand">
          <img src="logo.png" alt="Ã“ptica Cristal" />
          <div>
            <h1> v7 Editar trabajo</h1>
            <div class="small muted">CargÃ¡ el NÂ° de trabajo y desbloqueÃ¡ con tu contraseÃ±a para habilitar ediciÃ³n.</div>
          </div>
        </div>
        <div class="hdr-actions">
          <span id="lockPill" class="pill lock">ðŸ”’ Bloqueado</span>
        </div>
      </div>

      <div class="row cols-4" style="margin-top:10px">
        <div>
          <label>NÂ° de trabajo</label>
          <input id="nro_buscar" class="mono" placeholder="Ej: 50511181563" />
        </div>
        <div class="right">
          <label>&nbsp;</label>
          <div class="actions">
            <button id="btnCargar">Cargar</button>
            <button id="btnLimpiar" class="ghost">Limpiar</button>
          </div>
        </div>
        <div class="colspan"></div>
        <div class="right sm">
          Endpoint: <span class="mono" id="readEp"></span>
        </div>
      </div>
    </section>

    <!-- ====== LAYOUT PRINCIPAL (como cargamos): form a la izquierda / ticket a la derecha ====== -->
    <section class="grid two">
      <!-- ========= COLUMNA IZQUIERDA ========= -->
      <div class="card">

        <!-- Datos generales (solo lectura) -->
        <div class="row cols-4">
          <div>
            <label>NÂ° trabajo</label>
            <input id="numero_trabajo" class="mono" readonly />
          </div>
          <div>
            <label>DNI</label>
            <input id="dni" class="mono" readonly />
          </div>
          <div class="colspan" style="grid-column: span 2;">
            <label>Apellido y nombre</label>
            <input id="apellido" readonly />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label>TelÃ©fono</label>
            <input id="telefono" readonly />
          </div>
          <div class="colspan" style="grid-column: span 3;">
            <label>Localidad</label>
            <input id="localidad" readonly />
          </div>
        </div>

        <div class="hr"></div>

        <!-- Campos editables que me pediste -->
        <div class="row cols-4">
          <div class="colspan" style="grid-column: span 3;">
            <label>Tipo de cristal (G)</label>
            <input id="tipo_cristal" disabled placeholder="Monofocal / Bifocal / etc." />
          </div>
          <div>
            <label>Precio cristal (H)</label>
            <div class="money"><input id="precio_cristal" disabled placeholder="0" /></div>
          </div>
        </div>

        <div class="row cols-4">
          <div class="colspan" style="grid-column: span 3;">
            <label>Concepto negativo / Obra social (X)</label>
            <input id="concepto_negativo" disabled placeholder="Ej: O.S. o descuento" />
          </div>
          <div>
            <label>Precio obra social (Y)</label>
            <div class="money"><input id="precio_descuento" disabled placeholder="0" /></div>
          </div>
        </div>

        <div class="row cols-4">
          <div class="colspan" style="grid-column: span 3;">
            <label>Otro concepto (L)</label>
            <input id="otro_concepto" disabled placeholder="Ej: tratamiento" />
          </div>
          <div>
            <label>Precio otro (M)</label>
            <div class="money"><input id="precio_otro" disabled placeholder="0" /></div>
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label>OD ESF (O)</label>
            <input id="od_esf" disabled placeholder="0.00" />
          </div>
          <div>
            <label>OD CIL (P)</label>
            <input id="od_cil" disabled placeholder="0.00" />
          </div>
          <div>
            <label>OD EJE (Q)</label>
            <input id="od_eje" disabled placeholder="EJE" />
          </div>
          <div>
            <label>ADD (U)</label>
            <input id="add" disabled placeholder="0.00" />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label>OI ESF (R)</label>
            <input id="oi_esf" disabled placeholder="0.00" />
          </div>
          <div>
            <label>OI CIL (S)</label>
            <input id="oi_cil" disabled placeholder="0.00" />
          </div>
          <div>
            <label>OI EJE (T)</label>
            <input id="oi_eje" disabled placeholder="EJE" />
          </div>
          <div>
            <label>Vendedor (AF)</label>
            <input id="vendedor" disabled placeholder="JUAN / LUCAS / ..." />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label>Forma de pago (AC)</label>
            <select id="forma_pago" disabled>
              <option value="">ElegÃ­ una</option>
              <option>EFECTIVO</option>
              <option>DÃ‰BITO</option>
              <option>CRÃ‰DITO</option>
              <option>VISA 3 PAGOS</option>
              <option>TRANSFERENCIA</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <!-- AutenticaciÃ³n simple (contraseÃ±a en hoja externa) -->
        <div class="row cols-4">
          <div>
            <label>ContraseÃ±a</label>
            <input id="pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
          <div class="right">
            <label>&nbsp;</label>
            <div class="actions">
              <button id="btnUnlock" class="secondary">Desbloquear ediciÃ³n</button>
              <button id="btnGuardar" class="ghost" disabled>Guardar cambios</button>
            </div>
          </div>
        </div>

      </div>

      <!-- ========= COLUMNA DERECHA (Ticket de totales parecido) ========= -->
      <aside class="card">
        <div class="totals-ticket">
          <div class="tt-title">Desglose</div>

          <div class="tt-row"><span>ArmazÃ³n</span><span class="tt-val mono" id="tt_armazon">$ 0</span></div>
          <div class="tt-row"><span>Cristal</span><span class="tt-val mono" id="tt_cristal">$ 0</span></div>
          <div class="tt-row"><span>Otro concepto</span><span class="tt-val mono" id="tt_otro">$ 0</span></div>

          <div class="tt-row subtotal"><span>Subtotal</span><span class="tt-val mono" id="tt_subtotal">$ 0</span></div>

          <div class="tt-row rest"><span>â€“ Descuento / O.S.</span><span class="tt-val mono" id="tt_descuento">â€“ $ 0</span></div>
          <div class="tt-row rest"><span>â€“ SeÃ±a</span><span class="tt-val mono" id="tt_senia">â€“ $ 0</span></div>

          <div class="tt-row total" style="margin-top:6px;">
            <span>Saldo a pagar</span>
            <span class="tt-big mono" id="tt_total">$ 0</span>
          </div>

          <div class="tt-meter"><div id="tt_meter"></div></div>
        </div>

        <div class="hr"></div>

        <!-- GalerÃ­a (para el futuro, hoy sin fotos) -->
        <div>
          <div class="small muted" style="margin-bottom:6px;">GalerÃ­a</div>
          <div class="galeria" id="galeria"></div>
        </div>
      </aside>
    </section>
  </main>

  <script type="module">
    /********** CONFIG **********/
    const EDIT_URL = "https://script.google.com/macros/s/AKfycbxIOfNJwvsHqb-nE36EbtZE4EYw1l-BbUGptxj335dK5sSusgT9X_MBzwgjwRdOkBp4/exec";

    /********** HELPERS **********/
    const $ = s => document.querySelector(s);
    const byId = id => document.getElementById(id);
    const fmtMoney = v => {
      const n = Number(String(v).replace(/[^\d.-]/g,'') || 0);
      return n.toLocaleString('es-AR', {style:'currency', currency:'ARS', maximumFractionDigits:0});
    };
    const qstr = (base, params={})=>{
      const u = new URL(base);
      Object.entries(params).forEach(([k,v])=>{
        if(v!==undefined && v!==null && v!=='') u.searchParams.set(k,v);
      });
      return u.toString();
    };
    async function getJSON(url){
      const r = await fetch(url, { cache:'no-store' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    // Evita preflight (CORS): application/x-www-form-urlencoded
    async function postForm(url, data){
      const body = new URLSearchParams();
      for (const [k,v] of Object.entries(data)) {
        body.append(k, typeof v === 'string' ? v : JSON.stringify(v));
      }
      const r = await fetch(url, { method:'POST', body });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    function setDisabled(ids, disabled=true){
      ids.forEach(id => { const el = byId(id); if(el) el.disabled = disabled; });
      byId('btnGuardar').disabled = disabled;
      const pill = byId('lockPill');
      pill.textContent = disabled ? 'ðŸ”’ Bloqueado' : 'ðŸ”“ Desbloqueado';
      pill.className = 'pill ' + (disabled ? 'lock' : 'unlock');
    }
    function fill(map){
      Object.entries(map).forEach(([id,val])=>{
        const el = byId(id);
        if (el) { el.value = (val ?? ''); }
      });
    }
    function numberLike(v){
      const n = Number(String(v).replace(/[^\d.-]/g,''));
      return isFinite(n) ? n : 0;
    }

    /********** CAMPOS **********/
    const EDITABLE_IDS = [
      'tipo_cristal','precio_cristal',
      'concepto_negativo','precio_descuento',
      'otro_concepto','precio_otro',
      'od_esf','od_cil','od_eje','oi_esf','oi_cil','oi_eje','add',
      'forma_pago','vendedor'
    ];

    const MAP = {
      // solo lectura
      'NUMERO TRABAJO':'numero_trabajo',
      'DOCUMENTO':'dni',
      'APELLIDO Y NOMBRE':'apellido',
      'TELEFONO':'telefono',
      'LOCALIDAD':'localidad',
      // editables
      'CRISTAL':'tipo_cristal',
      'PRECIO CRISTAL':'precio_cristal',
      'OBRA SOCIAL':'concepto_negativo',
      'PRECIO OBRA SOCIAL':'precio_descuento',
      'OTRO CONCEPTO':'otro_concepto',
      'PRECIO OTRO':'precio_otro',
      'OD ESF':'od_esf','OD CIL':'od_cil','OD EJE':'od_eje',
      'OI ESF':'oi_esf','OI CIL':'oi_cil','OI EJE':'oi_eje',
      'ADD':'add',
      'FORMA DE PAGO':'forma_pago',
      'VENDEDOR':'vendedor',
      // para ticket (si existen en tu sheet)
      'PRECIO ARMAZON':'_tt_armazon',
      'SEÃ‘A':'_tt_senia',
      'TOTAL':'_tt_total'
    };

    const state = { hit:null, pass:null };

    /********** INIT **********/
    byId('readEp').textContent = EDIT_URL;

    // Autocargar si viene ?nro=
    (function(){
      const nro = new URLSearchParams(location.search).get('nro');
      if (nro) { byId('nro_buscar').value = nro; }
    })();

    // Limpiar
    byId('btnLimpiar').onclick = ()=>{
      document.querySelectorAll('input,select').forEach(el=>el.value='');
      setDisabled(EDITABLE_IDS, true);
      state.hit = null; state.pass = null;
      updateTicket();
    };

    // Cargar trabajo
    byId('btnCargar').onclick = async ()=>{
      const nro = byId('nro_buscar').value.trim();
      if (!nro) return alert('IngresÃ¡ el NÂ° de trabajo');

      try{
        const resp = await getJSON(qstr(EDIT_URL, { action:'getJobByNumber', nro, _:Date.now() }));
        if (!resp.ok) throw new Error(resp.error || 'Sin respuesta');
        if (!resp.hits?.length) return alert('No encontrado');

        const hit = resp.hits[0];
        state.hit = hit;

        // Mapeo a inputs
        const m = {'numero_trabajo': hit.nro};
        const row = hit.data || {};
        Object.entries(MAP).forEach(([col,id])=>{
          if (row[col] !== undefined && !id.startsWith('_')) m[id] = row[col];
        });
        fill(m);

        // Ticket inicial
        updateTicketFromRow(row);

        // Bloqueado por defecto
        setDisabled(EDITABLE_IDS, true);
      }catch(err){
        console.error(err);
        alert('Error al cargar');
      }
    };

    // Desbloquear (clave en hoja externa)
    byId('btnUnlock').onclick = async ()=>{
      const clave = byId('pass').value.trim();
      if(!clave) return alert('IngresÃ¡ la contraseÃ±a');

      try{
        const res = await postForm(EDIT_URL, { action:'authCheck', clave });
        if(res?.ok !== true) return alert('ContraseÃ±a incorrecta');
        state.pass = clave;
        setDisabled(EDITABLE_IDS, false);
      }catch(e){
        console.error(e);
        alert('No se pudo autenticar');
      }
    };

    // Guardar
    byId('btnGuardar').onclick = async ()=>{
      if(!state.hit) return alert('Primero cargÃ¡ un trabajo');
      if(!state.pass) return alert('DesbloqueÃ¡ con la contraseÃ±a');

      const cambios = {
        'CRISTAL': byId('tipo_cristal').value.trim(),
        'PRECIO CRISTAL': byId('precio_cristal').value.trim(),
        'OBRA SOCIAL': byId('concepto_negativo').value.trim(),
        'PRECIO OBRA SOCIAL': byId('precio_descuento').value.trim(),
        'OTRO CONCEPTO': byId('otro_concepto').value.trim(),
        'PRECIO OTRO': byId('precio_otro').value.trim(),
        'OD ESF': byId('od_esf').value.trim(),
        'OD CIL': byId('od_cil').value.trim(),
        'OD EJE': byId('od_eje').value.trim(),
        'OI ESF': byId('oi_esf').value.trim(),
        'OI CIL': byId('oi_cil').value.trim(),
        'OI EJE': byId('oi_eje').value.trim(),
        'ADD': byId('add').value.trim(),
        'FORMA DE PAGO': byId('forma_pago').value.trim(),
        'VENDEDOR': byId('vendedor').value.trim()
      };

      try{
        const res = await postForm(EDIT_URL, {
          action:'updateJob',
          nro: byId('numero_trabajo').value.trim(),
          clave: state.pass,
          cambios
        });
        if(res?.ok === true){
          alert('Cambios guardados âœ”');
          setDisabled(EDITABLE_IDS, true);
          // refresco ticket con valores actuales
          updateTicket();
        } else {
          alert('Error: ' + (res?.error || 'No se pudo actualizar'));
        }
      }catch(err){
        console.error(err);
        alert('No se pudo guardar');
      }
    };

    /********** TICKET (visual) **********/
    function updateTicketFromRow(row){
      const armazon  = numberLike(row['PRECIO ARMAZON']);
      const cristal  = numberLike(row['PRECIO CRISTAL']);
      const otro     = numberLike(row['PRECIO OTRO']);
      const desc     = numberLike(row['PRECIO OBRA SOCIAL']);
      const senia    = numberLike(row['SEÃ‘A']);
      const subtotal = armazon + cristal + otro;
      const total    = subtotal - desc - senia;

      byId('tt_armazon').textContent  = fmtMoney(armazon);
      byId('tt_cristal').textContent  = fmtMoney(cristal);
      byId('tt_otro').textContent     = fmtMoney(otro);
      byId('tt_subtotal').textContent = fmtMoney(subtotal);
      byId('tt_descuento').textContent= 'â€“ ' + fmtMoney(desc);
      byId('tt_senia').textContent    = 'â€“ ' + fmtMoney(senia);
      byId('tt_total').textContent    = fmtMoney(total);

      const meter = byId('tt_meter');
      const pct = subtotal>0 ? Math.max(0, Math.min(100, (senia/subtotal)*100)) : 0;
      meter.style.width = pct.toFixed(0) + '%';
    }

    function updateTicket(){
      // recalcula con lo que haya cargado en inputs del editor
      const armazon  = numberLike(0); // no se edita acÃ¡
      const cristal  = numberLike(byId('precio_cristal').value);
      const otro     = numberLike(byId('precio_otro').value);
      const desc     = numberLike(byId('precio_descuento').value);
      const senia    = numberLike(0); // no se edita acÃ¡
      const subtotal = armazon + cristal + otro;
      const total    = subtotal - desc - senia;

      byId('tt_armazon').textContent  = fmtMoney(armazon);
      byId('tt_cristal').textContent  = fmtMoney(cristal);
      byId('tt_otro').textContent     = fmtMoney(otro);
      byId('tt_subtotal').textContent = fmtMoney(subtotal);
      byId('tt_descuento').textContent= 'â€“ ' + fmtMoney(desc);
      byId('tt_senia').textContent    = 'â€“ ' + fmtMoney(senia);
      byId('tt_total').textContent    = fmtMoney(total);

      const meter = byId('tt_meter');
      const pct = subtotal>0 ? Math.max(0, Math.min(100, (senia/subtotal)*100)) : 0;
      meter.style.width = pct.toFixed(0) + '%';
    }

    // actualizar ticket en vivo si toca importes
    ['precio_cristal','precio_otro','precio_descuento'].forEach(id=>{
      const el = byId(id);
      el.addEventListener('input', updateTicket);
      el.addEventListener('change', updateTicket);
    });
  </script>
</body>
</html>
