<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>√ìptica Cristal ‚Ä¢ Editar trabajo</title>

  <meta name="theme-color" content="#111827" />
  <link rel="icon" type="image/png" href="logo.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- Estilos -->
  <link rel="stylesheet" href="css/estilos.css?v=4" />
  <link rel="stylesheet" href="css/print.css?v=1" />

  <!-- Notificaciones -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div class="title-row">
        <div class="brand">
          <img src="logo.png" alt="√ìptica Cristal" />
          <div>
            <h1>Editar trabajo v1 </h1>
            <p class="muted small">Cargar el N¬∞ y desbloquear con tu contrase√±a para habilitar edici√≥n.</p>
          </div>
        </div>

        <div class="row" style="grid-template-columns:minmax(220px, 320px) auto;">
          <div>
            <label for="numBuscar">N¬∞ de trabajo</label>
            <input id="numBuscar" inputmode="numeric" />
          </div>
          <div class="actions" style="align-self:end; display:flex; gap:.5rem;">
            <button id="btnCargar" class="secondary">Cargar</button>
            <button id="btnLimpiar" class="ghost">Limpiar</button>
          </div>
        </div>

        <small class="muted" id="endpointLabel"></small>

        <div id="lockBadge" class="pill" style="margin-top:.5rem; background:#fee2e2; color:#991b1b;">
          üîí Bloqueado
        </div>
      </div>
    </header>

    <!-- FICHA -->
    <form id="formEditar" class="grid two" autocomplete="off">
      <!-- Columna izquierda -->
      <section class="card grid">
        <div class="row cols-3">
          <div>
            <label>N¬∞ trabajo</label>
            <input id="nro" disabled />
          </div>
          <div>
            <label>DNI</label>
            <input id="dni" disabled />
          </div>
          <div>
            <label>Apellido y nombre</label>
            <input id="nombre" disabled />
          </div>
        </div>

        <div class="row cols-2">
          <div>
            <label>Tel√©fono</label>
            <input id="telefono" disabled />
          </div>
          <div>
            <label>Localidad</label>
            <input id="localidad" disabled />
          </div>
        </div>

        <!-- Campos editables (sin clave): GRADUACI√ìN -->
        <fieldset style="border:1px solid var(--muted-2); padding:.75rem; border-radius:.75rem;">
          <legend>Graduaci√≥n (editable sin contrase√±a)</legend>

          <div class="row cols-4">
            <div>
              <label>OD ESF (O)</label>
              <input id="od_esf" />
            </div>
            <div>
              <label>OD CIL (P)</label>
              <input id="od_cil" />
            </div>
            <div>
              <label>OD EJE (Q)</label>
              <input id="od_eje" />
            </div>
            <div>
              <label>DNP (V)</label>
              <input id="dnp" />
            </div>
          </div>

          <div class="row cols-4">
            <div>
              <label>OI ESF (R)</label>
              <input id="oi_esf" />
            </div>
            <div>
              <label>OI CIL (S)</label>
              <input id="oi_cil" />
            </div>
            <div>
              <label>OI EJE (T)</label>
              <input id="oi_eje" />
            </div>
            <div>
              <label>ADD (U)</label>
              <input id="add" />
            </div>
          </div>
        </fieldset>

        <!-- Campos protegidos (con contrase√±a) -->
        <fieldset style="border:1px solid var(--muted-2); padding:.75rem; border-radius:.75rem;">
          <legend>Campos editables (con contrase√±a)</legend>

          <div class="row cols-2">
            <div>
              <label>Tipo de cristal (G)</label>
              <input id="cristal" disabled />
            </div>
            <div>
              <label>Precio cristal (H)</label>
              <input id="precio_cristal" inputmode="numeric" disabled />
            </div>
          </div>

          <div class="row cols-2">
            <div>
              <label>Concepto negativo / Obra social (X)</label>
              <input id="obra_social" disabled />
            </div>
            <div>
              <label>Precio obra social (Y)</label>
              <input id="precio_obra_social" inputmode="numeric" disabled />
            </div>
          </div>

          <div class="row cols-2">
            <div>
              <label>Otro concepto (L)</label>
              <input id="otro_concepto" disabled />
            </div>
            <div>
              <label>Precio otro (M)</label>
              <input id="precio_otro" inputmode="numeric" disabled />
            </div>
          </div>

          <div class="row cols-2">
            <div>
              <label>Forma de pago (AC)</label>
              <input id="forma_pago" disabled />
            </div>
            <div>
              <label>Vendedor (AF)</label>
              <input id="vendedor" disabled />
            </div>
          </div>
        </fieldset>
      </section>

      <!-- Columna derecha -->
      <aside class="grid">
        <section class="card grid">
          <div class="row cols-1">
            <div>
              <label>N¬∞ armaz√≥n (I)</label>
              <input id="n_armazon" disabled />
            </div>
          </div>
          <div class="row cols-1">
            <div>
              <label>Detalle armaz√≥n (K)</label>
              <input id="detalle_armazon" disabled />
            </div>
          </div>
          <div class="row cols-1">
            <div>
              <label>Precio armaz√≥n (J)</label>
              <input id="precio_armazon" inputmode="numeric" disabled />
            </div>
          </div>

          <div class="row cols-1">
            <div class="actions" style="display:flex; gap:.5rem; flex-wrap:wrap">
              <button id="btnImprimir" type="button" class="ghost">Reimprimir</button>
              <button id="btnGuardar"  type="button">Guardar cambios</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="row cols-2">
            <div>
              <label>Contrase√±a</label>
              <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <div style="display:flex; align-items:flex-end;">
              <button id="btnUnlock" type="button" class="secondary">Desbloquear edici√≥n</button>
            </div>
          </div>
          <small class="muted">Al desbloquear, se habilitan los campos protegidos. La graduaci√≥n siempre es editable.</small>
        </section>
      </aside>
    </form>
  </div>

  <!-- JS: API y helpers -->
  <script type="module">
    import { API_URL, EDIT_URL } from './js/api.js';

    const $ = (id)=>document.getElementById(id);
    const endpointLabel = $('endpointLabel');
    endpointLabel.textContent = `Endpoint lectura: ${API_URL}`;

    // ===== util =====
    function setDisabled(ids, state) { ids.forEach(id => { const el = $(id); if (el) el.disabled = !!state; }); }
    function showError(t, m){ Swal.fire(t, m, 'error'); }
    function showOk(t, m){ Swal.fire(t, m, 'success'); }

    // Campos protegidos (se habilitan al desbloquear)
    const PROTEGIDOS = [
      'cristal','precio_cristal','obra_social','precio_obra_social',
      'otro_concepto','precio_otro','forma_pago','vendedor',
      'n_armazon','detalle_armazon','precio_armazon'
    ];
    // Al inicio: bloqueados
    setDisabled(PROTEGIDOS, true);

    // ===== Cargar por n√∫mero =====
    async function cargarPorNumero(nro){
      if(!nro) return showError('Falta n√∫mero','Ingres√° un N¬∞ de trabajo');
      try{
        const url = `${API_URL}?action=getJobByNumber&nro=${encodeURIComponent(nro)}`;
        const r = await fetch(url);
        const j = await r.json();
        if(!j.ok || !j.hits || !j.hits.length) {
          showError('No encontrado', `No se encontr√≥ el N¬∞ ${nro}`);
          return;
        }
        const data = j.hits[0].data;

        // Mapear columnas exactas a IDs de inputs (seg√∫n tu hoja)
        $('nro').value               = data['NUMERO TRABAJO'] || '';
        $('dni').value               = data['DOCUMENTO'] || '';
        $('nombre').value            = data['APELLIDO Y NOMBRE'] || '';
        $('telefono').value          = data['TELEFONO'] || '';
        $('localidad').value         = data['LOCALIDAD'] || '';

        $('od_esf').value            = data['OD ESF'] ?? '';
        $('od_cil').value            = data['OD CIL'] ?? '';
        $('od_eje').value            = data['OD EJE'] ?? '';
        $('oi_esf').value            = data['OI ESF'] ?? '';
        $('oi_cil').value            = data['OI CIL'] ?? '';
        $('oi_eje').value            = data['OI EJE'] ?? '';
        $('dnp').value               = data['DNP'] ?? '';
        $('add').value               = data['ADD'] ?? '';

        $('cristal').value           = data['CRISTAL'] || '';
        $('precio_cristal').value    = data['PRECIO CRISTAL'] || '';
        $('obra_social').value       = data['OBRA SOCIAL'] || '';
        $('precio_obra_social').value= data['PRECIO OBRA SOCIAL'] || '';
        $('otro_concepto').value     = data['OTRO CONCEPTO'] || '';
        $('precio_otro').value       = data['PRECIO OTRO'] || '';
        $('forma_pago').value        = data['FORMA DE PAGO'] || '';
        $('vendedor').value          = data['VENDEDOR'] || '';

        $('n_armazon').value         = data['N ANTEOJO'] || '';
        $('detalle_armazon').value   = data['DETALLE ARMAZON'] || '';
        $('precio_armazon').value    = data['PRECIO ARMAZON'] || '';

        $('lockBadge').textContent = 'üîí Bloqueado';
        $('lockBadge').style.background = '#fee2e2';
        $('lockBadge').style.color = '#991b1b';
      }catch(err){
        console.error(err);
        showError('Error','No se pudo cargar el trabajo');
      }
    }

    // Autocargar si viene ?num=
    const params = new URLSearchParams(location.search);
    const pre = params.get('num');
    if (pre) { $('numBuscar').value = pre; }

    // Botones cargar/limpiar
    $('btnCargar').addEventListener('click', ()=> cargarPorNumero($('numBuscar').value.trim()));
    $('btnLimpiar').addEventListener('click', ()=> location.href='editar.html');

    // ===== Desbloquear edici√≥n =====
    $('btnUnlock').addEventListener('click', async ()=>{
      const pass = $('pass').value.trim();
      if(!pass) return showError('Contrase√±a','Ingres√° la contrase√±a');
      try{
        const url = `${EDIT_URL}?action=checkPassword&pass=${encodeURIComponent(pass)}`;
        const r = await fetch(url);
        const j = await r.json();
        if(j.ok){
          setDisabled(PROTEGIDOS, false);
          $('lockBadge').textContent = 'üîì Desbloqueado';
          $('lockBadge').style.background = '#dcfce7';
          $('lockBadge').style.color = '#14532d';
          showOk('Listo','Edici√≥n habilitada');
        }else{
          showError('Contrase√±a incorrecta','No pudimos desbloquear');
        }
      }catch(e){
        console.error(e);
        showError('Error','No se pudo validar la contrase√±a');
      }
    });

    // ===== Guardar cambios =====
    $('btnGuardar').addEventListener('click', async ()=>{
      const nro = $('nro').value.trim();
      if(!nro) return showError('Falta N¬∞','Carg√° primero un trabajo');
      // Armamos payload con TODOS los campos editables:
      const body = {
        action: 'updateJob',
        nro,
        // Sin password, tu Apps Script deber√≠a aceptar siempre la parte de graduaci√≥n;
        // si est√° desbloqueado, tambi√©n el resto:
        datos: {
          'OD ESF': $('od_esf').value,
          'OD CIL': $('od_cil').value,
          'OD EJE': $('od_eje').value,
          'OI ESF': $('oi_esf').value,
          'OI CIL': $('oi_cil').value,
          'OI EJE': $('oi_eje').value,
          'ADD'   : $('add').value,
          'DNP'   : $('dnp').value,

          // protegidos (el GAS puede ignorarlos si no est√° desbloqueado)
          'CRISTAL': $('cristal').value,
          'PRECIO CRISTAL': $('precio_cristal').value,
          'OBRA SOCIAL': $('obra_social').value,
          'PRECIO OBRA SOCIAL': $('precio_obra_social').value,
          'OTRO CONCEPTO': $('otro_concepto').value,
          'PRECIO OTRO': $('precio_otro').value,
          'FORMA DE PAGO': $('forma_pago').value,
          'VENDEDOR': $('vendedor').value,
          'N ANTEOJO': $('n_armazon').value,
          'DETALLE ARMAZON': $('detalle_armazon').value,
          'PRECIO ARMAZON': $('precio_armazon').value
        }
      };
      try{
        const r = await fetch(EDIT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(j.ok){
          showOk('Guardado','Los cambios se actualizaron');
        }else{
          showError('No guard√≥', j.error || 'Error desconocido');
        }
      }catch(e){
        console.error(e);
        showError('Error','No se pudo guardar');
      }
    });

    // ===== Reimprimir =====
    window.collectDataForPrint = function(){
      // Reutilizamos los mismos IDs para armar el ticket
      return {
        fecha: '', // (opcional)
        retira: '',
        entrega: '',
        nro: $('nro')?.value || '',
        cliente: $('nombre')?.value || '',
        dni: $('dni')?.value || '',
        telefono: $('telefono')?.value || '',
        localidad: $('localidad')?.value || '',
        grad: {
          od: { esf: $('od_esf')?.value || '', cil: $('od_cil')?.value || '', eje: $('od_eje')?.value || '' },
          oi: { esf: $('oi_esf')?.value || '', cil: $('oi_cil')?.value || '', eje: $('oi_eje')?.value || '' },
          add: $('add')?.value || '',
          dnp: $('dnp')?.value || '',
        },
        dist: '', // opcional
        items: {
          cristal: { desc: $('cristal')?.value || '', precio: $('precio_cristal')?.value || '0' },
          armazon: { nro: $('n_armazon')?.value || '', desc: $('detalle_armazon')?.value || '', precio: $('precio_armazon')?.value || '0' },
          otro:    { desc: $('otro_concepto')?.value || '', precio: $('precio_otro')?.value || '0' },
        },
        totales: { total:'0', sena:'0', saldo:'0' }, // si quer√©s, calcul√°s de nuevo
        vendedor: $('vendedor')?.value || '',
        formaPago: $('forma_pago')?.value || '',
        qr: window.location.href
      };
    };
  </script>

  <!-- Ticket -->
  <script src="js/print.js"></script>
  <script>
    document.getElementById('btnImprimir')?.addEventListener('click', async () => {
      try{
        const data = window.collectDataForPrint();
        if (window.printTicket) {
          await window.printTicket(data);
        } else if (window.__buildPrintArea) {
          window.__buildPrintArea(data);
        } else {
          window.print();
        }
      }catch(e){
        console.error(e);
        window.print();
      }
    });
  </script>
</body>
</html>
