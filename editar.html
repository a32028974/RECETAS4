<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editar trabajo ‚Ä¢ √ìptica Cristal</title>
  <link rel="icon" type="image/png" href="logo.png" />
  <!-- Tus estilos globales (los que me pasaste) -->
  <link rel="stylesheet" href="css/estilos.css?v=2025-11-06" />
  <style>
    /* Ajustes m√≠nimos espec√≠ficos del editor */
    .hdr-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .pill.lock{ background:#fee2e2; color:#991b1b; }
    .pill.unlock{ background:#dcfce7; color:#14532d; }
    .sm { font-size:12px; color:var(--muted); }
    .money input { text-align:right; }
    .right { justify-self: end; }
  </style>
</head>
<body>
  <main class="wrap">

    <!-- ====== ENCABEZADO ====== -->
    <section class="card">
      <div class="title-row">
        <div class="brand">
          <img src="logo.png" alt="√ìptica Cristal" />
          <div>
            <h1> v9 Editar trabajo</h1>
            <div class="small muted">Carg√° el N¬∞ de trabajo y desbloque√° con tu contrase√±a para habilitar edici√≥n.</div>
          </div>
        </div>
        <div class="hdr-actions">
          <span id="lockPill" class="pill lock">üîí Bloqueado</span>
        </div>
      </div>

      <div class="row cols-4" style="margin-top:10px">
        <div>
          <label>N¬∞ de trabajo</label>
          <input id="nro_buscar" class="mono" placeholder="Ej: 50511181563" />
        </div>
        <div class="right">
          <label>&nbsp;</label>
          <div class="actions">
            <button id="btnCargar">Cargar</button>
            <button id="btnLimpiar" class="ghost">Limpiar</button>
          </div>
        </div>
        <div class="colspan"></div>
        <div class="right sm">
          Endpoint: <span class="mono" id="readEp"></span>
        </div>
      </div>
    </section>

    <!-- ====== LAYOUT PRINCIPAL (como cargamos): form a la izquierda / ticket a la derecha ====== -->
    <section class="grid two">
      <!-- ========= COLUMNA IZQUIERDA ========= -->
      <div class="card">

        <!-- Datos generales (solo lectura) -->
        <div class="row cols-4">
          <div>
            <label>N¬∞ trabajo</label>
            <input id="numero_trabajo" class="mono" readonly />
          </div>
          <div>
            <label>DNI</label>
            <input id="dni" class="mono" readonly />
          </div>
          <div class="colspan" style="grid-column: span 2;">
            <label>Apellido y nombre</label>
            <input id="apellido" readonly />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label>Tel√©fono</label>
            <input id="telefono" readonly />
          </div>
          <div class="colspan" style="grid-column: span 3;">
            <label>Localidad</label>
            <input id="localidad" readonly />
          </div>
        </div>

        <div class="hr"></div>

        <!-- Campos editables que me pediste -->
        <div class="row cols-4">
          <div class="colspan" style="grid-column: span 3;">
            <label>Tipo de cristal (G)</label>
            <input id="tipo_cristal" disabled placeholder="Monofocal / Bifocal / etc." />
          </div>
          <div>
            <label>Precio cristal (H)</label>
            <div class="money"><input id="precio_cristal" disabled placeholder="0" /></div>
          </div>
        </div>

        <div class="row cols-4">
          <div class="colspan" style="grid-column: span 3;">
            <label>Concepto negativo / Obra social (X)</label>
            <input id="concepto_negativo" disabled placeholder="Ej: O.S. o descuento" />
          </div>
          <div>
            <label>Precio obra social (Y)</label>
            <div class="money"><input id="precio_descuento" disabled placeholder="0" /></div>
          </div>
        </div>

        <div class="row cols-4">
          <div class="colspan" style="grid-column: span 3;">
            <label>Otro concepto (L)</label>
            <input id="otro_concepto" disabled placeholder="Ej: tratamiento" />
          </div>
          <div>
            <label>Precio otro (M)</label>
            <div class="money"><input id="precio_otro" disabled placeholder="0" /></div>
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label>OD ESF (O)</label>
            <input id="od_esf" disabled placeholder="0.00" />
          </div>
          <div>
            <label>OD CIL (P)</label>
            <input id="od_cil" disabled placeholder="0.00" />
          </div>
          <div>
            <label>OD EJE (Q)</label>
            <input id="od_eje" disabled placeholder="EJE" />
          </div>
          <div>
            <label>ADD (U)</label>
            <input id="add" disabled placeholder="0.00" />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label>OI ESF (R)</label>
            <input id="oi_esf" disabled placeholder="0.00" />
          </div>
          <div>
            <label>OI CIL (S)</label>
            <input id="oi_cil" disabled placeholder="0.00" />
          </div>
          <div>
            <label>OI EJE (T)</label>
            <input id="oi_eje" disabled placeholder="EJE" />
          </div>
          <div>
            <label>Vendedor (AF)</label>
            <input id="vendedor" disabled placeholder="JUAN / LUCAS / ..." />
          </div>
        </div>

        <div class="row cols-4">
          <div>
            <label>Forma de pago (AC)</label>
            <select id="forma_pago" disabled>
              <option value="">Eleg√≠ una</option>
              <option>EFECTIVO</option>
              <option>D√âBITO</option>
              <option>CR√âDITO</option>
              <option>VISA 3 PAGOS</option>
              <option>TRANSFERENCIA</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Autenticaci√≥n simple (contrase√±a en hoja externa) -->
        <div class="row cols-4">
          <div>
            <label>Contrase√±a</label>
            <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <div class="right">
            <label>&nbsp;</label>
            <div class="actions">
              <button id="btnUnlock" class="secondary">Desbloquear edici√≥n</button>
              <button id="btnGuardar" class="ghost" disabled>Guardar cambios</button>
            </div>
          </div>
        </div>

      </div>

      <!-- ========= COLUMNA DERECHA (Ticket de totales parecido) ========= -->
      <aside class="card">
        <div class="totals-ticket">
          <div class="tt-title">Desglose</div>

          <div class="tt-row"><span>Armaz√≥n</span><span class="tt-val mono" id="tt_armazon">$ 0</span></div>
          <div class="tt-row"><span>Cristal</span><span class="tt-val mono" id="tt_cristal">$ 0</span></div>
          <div class="tt-row"><span>Otro concepto</span><span class="tt-val mono" id="tt_otro">$ 0</span></div>

          <div class="tt-row subtotal"><span>Subtotal</span><span class="tt-val mono" id="tt_subtotal">$ 0</span></div>

          <div class="tt-row rest"><span>‚Äì Descuento / O.S.</span><span class="tt-val mono" id="tt_descuento">‚Äì $ 0</span></div>
          <div class="tt-row rest"><span>‚Äì Se√±a</span><span class="tt-val mono" id="tt_senia">‚Äì $ 0</span></div>

          <div class="tt-row total" style="margin-top:6px;">
            <span>Saldo a pagar</span>
            <span class="tt-big mono" id="tt_total">$ 0</span>
          </div>

          <div class="tt-meter"><div id="tt_meter"></div></div>
        </div>

        <div class="hr"></div>

        <!-- Galer√≠a (para el futuro, hoy sin fotos) -->
        <div>
          <div class="small muted" style="margin-bottom:6px;">Galer√≠a</div>
          <div class="galeria" id="galeria"></div>
        </div>
      </aside>
    </section>
  </main>

  <script type="module">
    /********** CONFIG **********/
    const EDIT_URL = "https://script.google.com/macros/s/AKfycbxIOfNJwvsHqb-nE36EbtZE4EYw1l-BbUGptxj335dK5sSusgT9X_MBzwgjwRdOkBp4/exec";

    /********** HELPERS **********/
    const params = new URLSearchParams(location.search);
const numero = params.get("num");
if (numero) {
  document.getElementById("numero_trabajo").value = numero;
  // si quer√©s que dispare autom√°ticamente el bot√≥n cargar:
  document.getElementById("btn-cargar").click();
}
    
    
    
    const $ = s => document.querySelector(s);
    const byId = id => document.getElementById(id);
    const fmtMoney = v => {
      const n = Number(String(v).replace(/[^\d.-]/g,'') || 0);
      return n.toLocaleString('es-AR', {style:'currency', currency:'ARS', maximumFractionDigits:0});
    };
    const qstr = (base, params={})=>{
      const u = new URL(base);
      Object.entries(params).forEach(([k,v])=>{
        if(v!==undefined && v!==null && v!=='') u.searchParams.set(k,v);
      });
      return u.toString();
    };
    async function getJSON(url){
      const r = await fetch(url, { cache:'no-store' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    // Evita preflight (CORS): application/x-www-form-urlencoded
    async function postForm(url, data){
      const body = new URLSearchParams();
      for (const [k,v] of Object.entries(data)) {
        body.append(k, typeof v === 'string' ? v : JSON.stringify(v));
      }
      const r = await fetch(url, { method:'POST', body });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    function setDisabled(ids, disabled=true){
      ids.forEach(id => { const el = byId(id); if(el) el.disabled = disabled; });
      byId('btnGuardar').disabled = disabled;
      const pill = byId('lockPill');
      pill.textContent = disabled ? 'üîí Bloqueado' : 'üîì Desbloqueado';
      pill.className = 'pill ' + (disabled ? 'lock' : 'unlock');
    }
    function fill(map){
      Object.entries(map).forEach(([id,val])=>{
        const el = byId(id);
        if (el) { el.value = (val ?? ''); }
      });
    }
    function numberLike(v){
      const n = Number(String(v).replace(/[^\d.-]/g,''));
      return isFinite(n) ? n : 0;
    }

    /********** CAMPOS **********/
    const EDITABLE_IDS = [
      'tipo_cristal','precio_cristal',
      'concepto_negativo','precio_descuento',
      'otro_concepto','precio_otro',
      'od_esf','od_cil','od_eje','oi_esf','oi_cil','oi_eje','add',
      'forma_pago','vendedor'
    ];

    const MAP = {
      // solo lectura
      'NUMERO TRABAJO':'numero_trabajo',
      'DOCUMENTO':'dni',
      'APELLIDO Y NOMBRE':'apellido',
      'TELEFONO':'telefono',
      'LOCALIDAD':'localidad',
      // editables
      'CRISTAL':'tipo_cristal',
      'PRECIO CRISTAL':'precio_cristal',
      'OBRA SOCIAL':'concepto_negativo',
      'PRECIO OBRA SOCIAL':'precio_descuento',
      'OTRO CONCEPTO':'otro_concepto',
      'PRECIO OTRO':'precio_otro',
      'OD ESF':'od_esf','OD CIL':'od_cil','OD EJE':'od_eje',
      'OI ESF':'oi_esf','OI CIL':'oi_cil','OI EJE':'oi_eje',
      'ADD':'add',
      'FORMA DE PAGO':'forma_pago',
      'VENDEDOR':'vendedor',
      // para ticket (si existen en tu sheet)
      'PRECIO ARMAZON':'_tt_armazon',
      'SE√ëA':'_tt_senia',
      'TOTAL':'_tt_total'
    };

    const state = { hit:null, pass:null };

    /********** INIT **********/
    byId('readEp').textContent = EDIT_URL;

    // Autocargar si viene ?nro=
    (function(){
      const nro = new URLSearchParams(location.search).get('nro');
      if (nro) { byId('nro_buscar').value = nro; }
    })();

    // Limpiar
    byId('btnLimpiar').onclick = ()=>{
      document.querySelectorAll('input,select').forEach(el=>el.value='');
      setDisabled(EDITABLE_IDS, true);
      state.hit = null; state.pass = null;
      updateTicket();
    };

    // Cargar trabajo
    byId('btnCargar').onclick = async ()=>{
      const nro = byId('nro_buscar').value.trim();
      if (!nro) return alert('Ingres√° el N¬∞ de trabajo');

      try{
        const resp = await getJSON(qstr(EDIT_URL, { action:'getJobByNumber', nro, _:Date.now() }));
        if (!resp.ok) throw new Error(resp.error || 'Sin respuesta');
        if (!resp.hits?.length) return alert('No encontrado');

        const hit = resp.hits[0];
        state.hit = hit;

        // Mapeo a inputs
        const m = {'numero_trabajo': hit.nro};
        const row = hit.data || {};
        Object.entries(MAP).forEach(([col,id])=>{
          if (row[col] !== undefined && !id.startsWith('_')) m[id] = row[col];
        });
        fill(m);

        // Ticket inicial
        updateTicketFromRow(row);

        // Bloqueado por defecto
        setDisabled(EDITABLE_IDS, true);
      }catch(err){
        console.error(err);
        alert('Error al cargar');
      }
    };

    // Desbloquear (clave en hoja externa)
    byId('btnUnlock').onclick = async ()=>{
      const clave = byId('pass').value.trim();
      if(!clave) return alert('Ingres√° la contrase√±a');

      try{
        const res = await postForm(EDIT_URL, { action:'authCheck', clave });
        if(res?.ok !== true) return alert('Contrase√±a incorrecta');
        state.pass = clave;
        setDisabled(EDITABLE_IDS, false);
      }catch(e){
        console.error(e);
        alert('No se pudo autenticar');
      }
    };

    // Guardar
    byId('btnGuardar').onclick = async ()=>{
      if(!state.hit) return alert('Primero carg√° un trabajo');
      if(!state.pass) return alert('Desbloque√° con la contrase√±a');

      const cambios = {
        'CRISTAL': byId('tipo_cristal').value.trim(),
        'PRECIO CRISTAL': byId('precio_cristal').value.trim(),
        'OBRA SOCIAL': byId('concepto_negativo').value.trim(),
        'PRECIO OBRA SOCIAL': byId('precio_descuento').value.trim(),
        'OTRO CONCEPTO': byId('otro_concepto').value.trim(),
        'PRECIO OTRO': byId('precio_otro').value.trim(),
        'OD ESF': byId('od_esf').value.trim(),
        'OD CIL': byId('od_cil').value.trim(),
        'OD EJE': byId('od_eje').value.trim(),
        'OI ESF': byId('oi_esf').value.trim(),
        'OI CIL': byId('oi_cil').value.trim(),
        'OI EJE': byId('oi_eje').value.trim(),
        'ADD': byId('add').value.trim(),
        'FORMA DE PAGO': byId('forma_pago').value.trim(),
        'VENDEDOR': byId('vendedor').value.trim()
      };

      try{
        const res = await postForm(EDIT_URL, {
          action:'updateJob',
          nro: byId('numero_trabajo').value.trim(),
          clave: state.pass,
          cambios
        });
        if(res?.ok === true){
          alert('Cambios guardados ‚úî');
          setDisabled(EDITABLE_IDS, true);
          // refresco ticket con valores actuales
          updateTicket();
        } else {
          alert('Error: ' + (res?.error || 'No se pudo actualizar'));
        }
      }catch(err){
        console.error(err);
        alert('No se pudo guardar');
      }
    };

    /********** TICKET (visual) **********/
    function updateTicketFromRow(row){
      const armazon  = numberLike(row['PRECIO ARMAZON']);
      const cristal  = numberLike(row['PRECIO CRISTAL']);
      const otro     = numberLike(row['PRECIO OTRO']);
      const desc     = numberLike(row['PRECIO OBRA SOCIAL']);
      const senia    = numberLike(row['SE√ëA']);
      const subtotal = armazon + cristal + otro;
      const total    = subtotal - desc - senia;

      byId('tt_armazon').textContent  = fmtMoney(armazon);
      byId('tt_cristal').textContent  = fmtMoney(cristal);
      byId('tt_otro').textContent     = fmtMoney(otro);
      byId('tt_subtotal').textContent = fmtMoney(subtotal);
      byId('tt_descuento').textContent= '‚Äì ' + fmtMoney(desc);
      byId('tt_senia').textContent    = '‚Äì ' + fmtMoney(senia);
      byId('tt_total').textContent    = fmtMoney(total);

      const meter = byId('tt_meter');
      const pct = subtotal>0 ? Math.max(0, Math.min(100, (senia/subtotal)*100)) : 0;
      meter.style.width = pct.toFixed(0) + '%';
    }

    function updateTicket(){
      // recalcula con lo que haya cargado en inputs del editor
      const armazon  = numberLike(0); // no se edita ac√°
      const cristal  = numberLike(byId('precio_cristal').value);
      const otro     = numberLike(byId('precio_otro').value);
      const desc     = numberLike(byId('precio_descuento').value);
      const senia    = numberLike(0); // no se edita ac√°
      const subtotal = armazon + cristal + otro;
      const total    = subtotal - desc - senia;

      byId('tt_armazon').textContent  = fmtMoney(armazon);
      byId('tt_cristal').textContent  = fmtMoney(cristal);
      byId('tt_otro').textContent     = fmtMoney(otro);
      byId('tt_subtotal').textContent = fmtMoney(subtotal);
      byId('tt_descuento').textContent= '‚Äì ' + fmtMoney(desc);
      byId('tt_senia').textContent    = '‚Äì ' + fmtMoney(senia);
      byId('tt_total').textContent    = fmtMoney(total);

      const meter = byId('tt_meter');
      const pct = subtotal>0 ? Math.max(0, Math.min(100, (senia/subtotal)*100)) : 0;
      meter.style.width = pct.toFixed(0) + '%';
    }

    // actualizar ticket en vivo si toca importes
    ['precio_cristal','precio_otro','precio_descuento'].forEach(id=>{
      const el = byId(id);
      el.addEventListener('input', updateTicket);
      el.addEventListener('change', updateTicket);
    });
  </script>
<script>
/**
 * Este helper arma un DOM oculto con los IDs que print.js espera,
 * toma los valores desde los campos presentes en editar.html
 * y llama a __buildPrintArea() para imprimir con el mismo dise√±o.
 */
(() => {
  const $ = (sel) => document.querySelector(sel);
  const byId = (id) => document.getElementById(id);

  // Busca un valor en varios selectores posibles (por si tus IDs difieren)
  function pick(...sels) {
    for (const s of sels) {
      const el = typeof s === 'string' ? $(s) : s;
      if (el) {
        if (el.tagName === 'SELECT') {
          const opt = el.options[el.selectedIndex];
          return (opt?.textContent || opt?.value || '').trim();
        }
        return (el.value || '').trim();
      }
    }
    return '';
  }

  // Crea (o limpia) el contenedor oculto est√°ndar para print.js
  function ensureShadowForm() {
    let wrap = byId('__print_shadow__');
    if (!wrap) {
      wrap = document.createElement('div');
      wrap.id = '__print_shadow__';
      wrap.style.cssText = 'position:fixed;left:-9999px;top:-9999px;visibility:hidden;';
      document.body.appendChild(wrap);
    }
    wrap.innerHTML = `
      <input id="numero_trabajo">
      <input id="fecha">
      <select id="entrega-select"><option></option></select>
      <input id="fecha_retira">
      <input id="dni">
      <input id="nombre">
      <input id="telefono">
      <input id="localidad">

      <input id="cristal">
      <input id="precio_cristal">
      <input id="obra_social">
      <input id="importe_obra_social">

      <input id="numero_armazon">
      <input id="armazon_detalle">
      <input id="precio_armazon">

      <input id="otro_concepto">
      <input id="precio_otro">

      <input id="vendedor">
      <input id="forma_pago">

      <select id="distancia_focal"><option></option></select>

      <select id="od_esf"></select>
      <select id="od_cil"></select>
      <input  id="od_eje">
      <select id="oi_esf"></select>
      <select id="oi_cil"></select>
      <input  id="oi_eje">

      <input id="dnp">
      <input id="add">
      <input id="dr">

      <!-- se√±a hidden (print.js la usa si est√°) -->
      <input id="sena" value="0">
      <!-- backup visible (por las dudas) -->
      <input id="seniaInput" value="0">
      <!-- total/saldo (print.js no los requiere para render, los calcula) -->
      <input id="total" value="0">
      <input id="saldo" value="0">
    `;
    return wrap;
  }

  // Copi√° aqu√≠ las correspondencias desde tus campos de "editar"
  function fillShadowFromEditar() {
    const w = ensureShadowForm();

    // N¬∞ trabajo, fechas y cabecera
    byId('numero_trabajo').value = pick('#nroTrabajo', '#numTrabajo', '#numero_trabajo', '[name="numero_trabajo"]');
    byId('fecha').value          = pick('#fecha', '[name="fecha"]');
    // "entrega-select" es un SELECT: le seteo el texto en su √∫nica opci√≥n
    byId('entrega-select').options[0].textContent = pick('#entrega', '#modalidad', '#entrega-select');
    byId('fecha_retira').value   = pick('#fechaRetira', '#fecha_retira', '[name="fecha_retira"]');

    // Identificaci√≥n cliente
    byId('dni').value       = pick('#dni', '[name="dni"]');
    byId('nombre').value    = pick('#nombre', '[name="nombre"]');
    byId('telefono').value  = pick('#telefono', '[name="telefono"]');
    byId('localidad').value = pick('#localidad', '[name="localidad"]');

    // Productos / precios
    byId('cristal').value           = pick('#tipoCristal', '#cristal', '[name="cristal"]');
    byId('precio_cristal').value    = pick('#precioCristal', '#precio_cristal', '[name="precio_cristal"]');
    byId('obra_social').value       = pick('#conceptoNegativo', '#obra_social', '[name="obra_social"]');
    byId('importe_obra_social').value = pick('#precioObraSocial', '#importe_obra_social', '[name="importe_obra_social"]');

    byId('numero_armazon').value    = pick('#nArmazon', '#numero_armazon', '[name="numero_armazon"]');
    byId('armazon_detalle').value   = pick('#detalleArmazon', '#armazon_detalle', '[name="armazon_detalle"]');
    byId('precio_armazon').value    = pick('#precioArmazon', '#precio_armazon', '[name="precio_armazon"]');

    byId('otro_concepto').value     = pick('#otroConcepto', '#otro_concepto', '[name="otro_concepto"]');
    byId('precio_otro').value       = pick('#precioOtro', '#precio_otro', '[name="precio_otro"]');

    // Vendedor / pago
    byId('vendedor').value          = pick('#vendedor', '[name="vendedor"]');
    byId('forma_pago').value        = pick('#formaPago', '#forma_pago', '[name="forma_pago"]');

    // Datos √≥pticos
    byId('distancia_focal').options[0].textContent = pick('#distanciaFocal', '#distancia_focal');
    // OD
    byId('od_esf').innerHTML = `<option>${pick('#od_esf', '[name="od_esf"]')||''}</option>`;
    byId('od_cil').innerHTML = `<option>${pick('#od_cil', '[name="od_cil"]')||''}</option>`;
    byId('od_eje').value     = pick('#od_eje', '[name="od_eje"]');
    // OI
    byId('oi_esf').innerHTML = `<option>${pick('#oi_esf', '[name="oi_esf"]')||''}</option>`;
    byId('oi_cil').innerHTML = `<option>${pick('#oi_cil', '[name="oi_cil"]')||''}</option>`;
    byId('oi_eje').value     = pick('#oi_eje', '[name="oi_eje"]');

    byId('dnp').value = pick('#dnp', '[name="dnp"]');
    byId('add').value = pick('#add', '[name="add"]');
    byId('dr').value  = pick('#dr', '[name="dr"]');

    // Se√±a (si en editar us√°s otro id, mapealo ac√°)
    const senia = pick('#sena', '#senia', '#seniaInput', '[name="sena"]', '[name="seniaInput"]') || '0';
    byId('sena').value = senia;
    byId('seniaInput').value = senia;
  }

  byId('btn-reimprimir')?.addEventListener('click', () => {
    try {
      fillShadowFromEditar();
      if (typeof window.__buildPrintArea === 'function') {
        window.__buildPrintArea(); // usa print.js (ticket A4 + tal√≥n + barcode)
      } else {
        alert('No se encontr√≥ print.js. Agreg√° <script src="js/print.js"></script> en editar.html');
      }
    } catch (e) {
      console.error(e);
      alert('No se pudo preparar la reimpresi√≥n.');
    }
  });
})();
</script>

  
  <button id="btn-reimprimir" type="button" class="secondary">Reimprimir</button>

</body>
</html>
