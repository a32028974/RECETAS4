<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>√ìptica Cristal ‚Ä¢ Carga de trabajos</title>

  <meta name="theme-color" content="#111827" />
  <link rel="icon" type="image/png" href="logo.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- Estilos -->
  <link rel="stylesheet" href="css/estilos.css?v=4" />
  <link rel="stylesheet" href="css/print.css?v=1" />

  <!-- Notificaciones -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <!-- Overlay de carga -->
  <div id="spinner" class="spinner no-print" aria-hidden="true" hidden>
    <div class="loader"></div>
    <div class="spinner-text">Cargando‚Ä¶</div>
  </div>

  <div class="wrap">
    <!-- Encabezado -->
    <header class="card">
      <div class="title-row">
        <div class="brand">
          <img src="logo.png" alt="√ìptica Cristal" />
          <div>
            <h1>v14 √ìptica Cristal</h1>
            <p class="muted small">San Miguel ‚Ä¢ Argentina</p>
          </div>
        </div>
        <div class="row" style="grid-template-columns:minmax(220px, 320px) auto;">
          <div>
            <label for="numero_trabajo">N√∫mero de trabajo</label>
            <input id="numero_trabajo" name="numero_trabajo" form="formulario"
                   inputmode="numeric" autocomplete="off" />
          </div>

          <!-- Badge MODO EDICI√ìN (no se usa en index, pero lo dejamos por compat) -->
          <div style="align-self:end; display:flex; gap:.5rem; align-items:center;">
            <input type="hidden" id="numero_trabajo_hidden" name="numero_trabajo_hidden" />
            <span id="edit_badge" style="display:none;padding:4px 8px;border-radius:6px;background:#fde047;color:#1f2937;font-weight:600;">
              MODO EDICI√ìN
            </span>
          </div>
        </div>
      </div>
    </header>

    <!-- Formulario principal -->
    <form id="formulario" class="grid two" autocomplete="off">
      <input type="hidden" id="pack_url" name="pdf" />

      <!-- Columna izquierda -->
      <section class="card grid" aria-label="Datos del trabajo">
        <div class="row cols-3">
          <div>
            <label for="fecha">Fecha que encarga</label>
            <input id="fecha" name="fecha" placeholder="dd/mm/aa" />
          </div>
          <div>
            <label for="entrega-select" class="small">Modalidad de entrega</label>
            <select id="entrega-select" name="entrega">
              <option value="" selected disabled>Eleg√≠ una opci√≥n</option>
              <option value="7">Stock (7 d√≠as)</option>
              <option value="3">Urgente (3 d√≠as)</option>
              <option value="15">Laboratorio (15 d√≠as)</option>
            </select>
          </div>
          <div>
            <label for="fecha_retira">Fecha que retira (estimada)</label>
            <input id="fecha_retira" name="fecha_retira" type="date" />
          </div>
        </div>

        <div class="row cols-3">
          <div>
            <label for="dni">DNI</label>
            <input id="dni" name="dni" inputmode="numeric" />
            <div id="dni-loading" class="inline-loader" hidden>
              <span class="pill">Buscando‚Ä¶</span>
            </div>
          </div>
          <div>
            <label for="nombre">Apellido y nombre</label>
            <input id="nombre" name="nombre" placeholder="Apellido primero" />
          </div>
          <div>
            <label for="telefono">Tel√©fono</label>
            <input id="telefono" name="telefono" autocomplete="tel" placeholder="11 2345 6789" />
          </div>
        </div>

        <div class="row cols-1">
          <div>
            <label for="localidad">Localidad</label>
            <input id="localidad" name="localidad"
                   placeholder="San Miguel, Mu√±iz, Bella Vista‚Ä¶"
                   autocomplete="address-level2" enterkeyhint="next" />
          </div>
        </div>

        <div class="row cols-2">
          <div>
            <label for="cristal">Tipo de cristal</label>
            <input id="cristal" name="cristal" placeholder="Monofocal / Bifocal / etc." />
          </div>
          <div>
            <label for="precio_cristal">Precio cristal</label>
            <div class="money"><input id="precio_cristal" name="precio_cristal" inputmode="numeric" /></div>
          </div>
        </div>

        <div class="row cols-2">
          <div>
            <label for="obra_social">Concepto negativo</label>
            <input id="obra_social" name="obra_social" placeholder="Ej: O.S. o descuento" />
          </div>
          <div>
            <label for="importe_obra_social">- Descuento</label>
            <div class="money"><input id="importe_obra_social" name="importe_obra_social" inputmode="numeric" /></div>
          </div>
        </div>

        <!-- OD -->
        <div class="row cols-4">
          <div>
            <label for="od_esf">OD ESF</label>
            <select id="od_esf" name="od_esf"></select>
          </div>
          <div>
            <label for="od_cil">OD CIL</label>
            <select id="od_cil" name="od_cil"></select>
          </div>
          <div>
            <label for="od_eje">OD EJE</label>
            <input id="od_eje" name="od_eje" inputmode="numeric" placeholder="EJE" />
          </div>
          <div>
            <label for="distancia_focal">Distancia focal <span class="small muted">(obligatorio)</span></label>
            <select id="distancia_focal" name="distancia_focal" required>
              <option value="" selected disabled>Eleg√≠ una opci√≥n</option>
              <option>MONOFOCAL LEJOS</option>
              <option>MONOFOCAL CERCA</option>
              <option>BIFOCAL</option>
              <option>MULTIFOCAL</option>
              <option>OCUPACIONAL</option>
              <option>MONOFOCAL INTERMEDIA</option>
              <option>SOBRE LC</option>
            </select>
          </div>
        </div>

        <!-- OI -->
        <div class="row cols-4">
          <div>
            <label for="oi_esf">OI ESF</label>
            <select id="oi_esf" name="oi_esf"></select>
          </div>
          <div>
            <label for="oi_cil">OI CIL</label>
            <select id="oi_cil" name="oi_cil"></select>
          </div>
          <div>
            <label for="oi_eje">OI EJE</label>
            <input id="oi_eje" name="oi_eje" inputmode="numeric" placeholder="EJE" />
          </div>
        </div>

        <div class="row cols-3">
          <div>
            <label for="dr">Dr. (oculista)</label>
            <input id="dr" name="dr" placeholder="Opcional" />
          </div>
          <div>
            <label for="dnp">DNP (OD/OI)</label>
            <input id="dnp" name="dnp" placeholder="30/30" />
          </div>
          <div>
            <label for="add">ADD</label>
            <input id="add" name="add" class="grad grad-add" inputmode="numeric" placeholder="0.00" />
          </div>
        </div>

        <div class="row cols-3">
          <div>
            <label for="otro_concepto">Otro concepto</label>
            <input id="otro_concepto" name="otro_concepto" placeholder="Ej: tratamiento" />
          </div>
          <div>
            <label for="precio_otro">Precio otro</label>
            <div class="money"><input id="precio_otro" name="precio_otro" inputmode="numeric" /></div>
          </div>
        </div>

        <div class="row cols-3">
          <div>
            <label for="vendedor">Vendedor</label>
            <input id="vendedor" name="vendedor" />
          </div>
          <div>
            <label for="forma_pago">Forma de pago</label>
            <input id="forma_pago" name="forma_pago" />
          </div>
        </div>
      </section>

      <!-- Columna derecha -->
      <aside class="grid" aria-label="Armaz√≥n y totales">
        <section class="card grid">
          <div class="row cols-3">
            <div>
              <label for="numero_armazon">N¬∞ armaz√≥n</label>
              <input id="numero_armazon" name="numero_armazon" inputmode="text"
                     autocapitalize="characters" autocorrect="off" spellcheck="false"
                     maxlength="12" placeholder="Ej: 13336" />
              <div id="armazon-loading" class="inline-loader" hidden>
                <span class="pill">Buscando‚Ä¶</span>
              </div>
            </div>
            <div>
              <label for="armazon_detalle">Detalle armaz√≥n</label>
              <input id="armazon_detalle" name="armazon_detalle" placeholder="Marca / Modelo / Color" />
            </div>
            <div>
              <label for="precio_armazon">Precio armaz√≥n</label>
              <div class="money"><input id="precio_armazon" name="precio_armazon" inputmode="numeric" /></div>
            </div>
          </div>

          <!-- Desglose -->
          <div class="totals-ticket" id="totales-panel">
            <div class="tt-title">Desglose</div>
            <div class="tt-row sum"><span>Armaz√≥n</span><span id="tt-armazon" class="tt-val">$ 0</span></div>
            <div class="tt-row sum"><span>Cristal</span><span id="tt-cristal" class="tt-val">$ 0</span></div>

            <div class="tt-row sum" id="tt-row-otro">
              <span id="tt-otro-label">Otro concepto</span>
              <span id="tt-otro" class="tt-val">$ 0</span>
            </div>

            <div class="tt-row subtotal">
              <span>Subtotal</span>
              <span id="tt-subtotal" class="tt-val">$ 0</span>
            </div>

            <div class="row it">
              <span class="lbl">Se√±a</span>
              <div class="money"><input id="seniaInput" type="text" inputmode="numeric" value="0" autocomplete="off" /></div>
            </div>

            <div class="tt-row rest" id="tt-row-obra">
              <span id="tt-obra-label">‚àí </span>
              <span id="tt-obra" class="tt-val">‚àí $ 0</span>
            </div>

            <div class="tt-row rest">
              <span>‚àí Se√±a</span>
              <span id="tt-sena" class="tt-val">‚àí $ 0</span>
            </div>

            <div class="tt-divider"></div>

            <div class="tt-row total">
              <span>Saldo a pagar</span>
              <span id="tt-saldo" class="tt-val tt-big">$ 0</span>
            </div>

            <div class="tt-meter" title="Progreso de pago">
              <div id="tt-meter-fill"></div>
            </div>
          </div>

          <!-- Inputs ocultos -->
          <div class="visually-hidden">
            <div class="row cols-3">
              <div>
                <label for="total">Total</label>
                <div class="money"><input id="total" name="total" inputmode="numeric" readonly /></div>
              </div>
              <div>
                <label for="sena">Se√±a</label>
                <div class="money"><input id="sena" name="sena" inputmode="numeric" /></div>
              </div>
              <div>
                <label for="saldo">Saldo</label>
                <div class="money"><input id="saldo" name="saldo" inputmode="numeric" readonly /></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Fotos -->
        <section class="card grid no-print">
          <div class="actions">
            <button id="btn-foto"    type="button" class="secondary">üì∑ Foto</button>
            <button id="btn-galeria" type="button" class="secondary">üñºÔ∏è Galer√≠a</button>
          </div>
          <div id="galeria-fotos" class="galeria"></div>
        </section>

        <!-- Acciones -->
        <section class="card grid no-print">
          <div class="actions" style="flex-wrap:wrap; gap:.5rem">
            <button id="btn-imprimir" type="button" class="ghost">Imprimir</button>
            <button id="btn-limpiar"  type="button" class="secondary">Limpiar</button>
            <button type="submit">Guardar</button>
            <button id="btn-editar" type="button" class="secondary">Editar</button>
          </div>
        </section>
      </aside>
    </form>
  </div>

  <!-- Modal de c√°mara (si lo us√°s con fotoPack) -->
  <div id="cam-modal" class="cam-modal" hidden>
    <div class="cam-dialog">
      <div class="cam-head">
        <span>C√°mara</span>
        <button id="cam-close-x" class="cam-close" type="button">Cerrar</button>
      </div>
      <div class="cam-body">
        <video id="cam-video" playsinline></video>
        <div id="cam-preview"><canvas id="cam-shot"></canvas></div>
      </div>
      <div class="cam-actions">
        <button id="cam-tomar"   type="button">Tomar foto</button>
        <button id="cam-usar"    type="button" disabled>Usar esta</button>
        <button id="cam-cancelar" type="button">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- JS principales -->
  <script type="module" src="js/main.js?v=2025-11-05"></script>
  <script src="js/print.js"></script> <!-- para ticket de impresi√≥n -->

  <!-- Handlers finales -->
  <script type="module">
    import { parseMoney, sanitizePrice } from './js/utils.js';

    const $  = (id) => document.getElementById(id);
    const fmt = (n) => '$ ' + Math.max(0, Math.round(n||0)).toLocaleString('es-AR');

    // ====== Totales en vivo ======
    const fields = {
      precio_armazon: $('precio_armazon'),
      precio_cristal: $('precio_cristal'),
      precio_otro:    $('precio_otro'),
      otro_concepto:  $('otro_concepto'),
      importe_obra_social: $('importe_obra_social'),
      concepto_negativo:   $('obra_social'),
      sena: $('sena'),
      total: $('total'),
      saldo: $('saldo'),
      seniaInput: $('seniaInput'),
    };
    const view = {
      armazon:   $('tt-armazon'),
      cristal:   $('tt-cristal'),
      otro:      $('tt-otro'),
      otroLabel: $('tt-otro-label'),
      obra:      $('tt-obra'),
      obraLabel: $('tt-obra-label'),
      subtotal:  $('tt-subtotal'),
      sena:      $('tt-sena'),
      saldo:     $('tt-saldo'),
      meter:     $('tt-meter-fill'),
      rowOtro:   $('tt-row-otro'),
      rowObra:   $('tt-row-obra'),
    };
    function val(el){ return parseMoney(el?.value || 0); }
    function syncSeniaHidden(){
      if (!fields.seniaInput || !fields.sena) return;
      fields.sena.value = fields.seniaInput.value || '0';
      fields.sena.dispatchEvent(new Event('input', {bubbles:true}));
      fields.sena.dispatchEvent(new Event('change', {bubbles:true}));
    }
    function updateTotals(){
      const ar = val(fields.precio_armazon);
      const cr = val(fields.precio_cristal);
      const ot = val(fields.precio_otro);
      const os = val(fields.importe_obra_social);
      const se = val(fields.sena);

      const subtotal = ar + cr + ot;
      const total    = subtotal;
      const saldo    = Math.max(0, total - os - se);

      view.armazon.textContent  = fmt(ar);
      view.cristal.textContent  = fmt(cr);
      view.subtotal.textContent = fmt(subtotal);
      view.sena.textContent     = '‚àí ' + fmt(se);
      view.saldo.textContent    = fmt(saldo);

      const txtOtro = (fields.otro_concepto?.value || '').trim();
      view.otroLabel.textContent = txtOtro || 'Otro concepto';
      view.rowOtro.hidden = !(ot > 0 && txtOtro);

      const txtNeg = (fields.concepto_negativo?.value || '').trim();
      view.obraLabel.textContent = '‚àí ' + (txtNeg || '');
      view.rowObra.hidden = !(os > 0 && txtNeg);

      const pct = total > 0 ? Math.min(100, Math.max(0, Math.round((se / total) * 100))) : 0;
      view.meter.style.width = pct + '%';

      if (fields.total) fields.total.value = total;
      if (fields.saldo) fields.saldo.value = saldo;
    }
    const moneyInputs = [
      fields.precio_armazon,
      fields.precio_cristal,
      fields.precio_otro,
      fields.importe_obra_social,
      fields.sena,
      fields.seniaInput,
    ].filter(Boolean);
    moneyInputs.forEach(el => {
      el.addEventListener('input', () => { sanitizePrice(el); if (el === fields.seniaInput) syncSeniaHidden(); updateTotals(); });
      el.addEventListener('blur',  () => { if (el === fields.seniaInput) syncSeniaHidden(); updateTotals(); });
      el.addEventListener('change',() => { if (el === fields.seniaInput) syncSeniaHidden(); updateTotals(); });
    });
    [fields.otro_concepto, fields.concepto_negativo].forEach(el => {
      if (el) ['input','change','blur'].forEach(ev => el.addEventListener(ev, updateTotals));
    });
    syncSeniaHidden(); updateTotals();

    // ====== Bot√≥n Editar ‚áí s√≥lo redirigir ======
    document.getElementById('btn-editar')?.addEventListener('click', () => {
      window.location.href = 'editar.html';
    });

    // ====== Bot√≥n Imprimir ‚áí ticket ======
    function collectDataForPrint() {
      const entregaSel = $('entrega-select');
      return {
        fecha: $('fecha')?.value || '',
        retira: $('fecha_retira')?.value || '',
        entrega: entregaSel?.selectedOptions?.[0]?.textContent || '',
        nro: $('numero_trabajo')?.value || $('numero_trabajo_hidden')?.value || '',
        cliente: $('nombre')?.value || '',
        dni: $('dni')?.value || '',
        telefono: $('telefono')?.value || '',
        localidad: $('localidad')?.value || '',
        grad: {
          od: { esf: $('od_esf')?.value || '', cil: $('od_cil')?.value || '', eje: $('od_eje')?.value || '' },
          oi: { esf: $('oi_esf')?.value || '', cil: $('oi_cil')?.value || '', eje: $('oi_eje')?.value || '' },
          add: $('add')?.value || '',
          dnp: $('dnp')?.value || '',
        },
        dist: $('distancia_focal')?.value || '',
        items: {
          cristal: { desc: $('cristal')?.value || '', precio: $('precio_cristal')?.value || '0' },
          armazon: { nro: $('numero_armazon')?.value || '', desc: $('armazon_detalle')?.value || '', precio: $('precio_armazon')?.value || '0' },
          otro:    { desc: $('otro_concepto')?.value || '', precio: $('precio_otro')?.value || '0' },
        },
        totales: {
          total: $('total')?.value || '0',
          sena: $('sena')?.value || '0',
          saldo: $('saldo')?.value || '0',
        },
        vendedor: $('vendedor')?.value || '',
        formaPago: $('forma_pago')?.value || '',
        qr: window.location.href
      };
    }
    document.getElementById('btn-imprimir')?.addEventListener('click', async () => {
      try {
        const data = collectDataForPrint();
        if (window.printTicket) {
          await window.printTicket(data);
        } else if (window.__buildPrintArea) {
          window.__buildPrintArea(data);
        } else {
          window.print(); // fallback
        }
      } catch (e) {
        console.error(e);
        window.print();
      }
    });
  </script>

  <footer>Desarrollado por Juan Ignacio Solis.</footer>
</body>
</html>
